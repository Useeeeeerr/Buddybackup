<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Discord Bot Data Manager</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: #f0f2f5; color: #1c1e21; margin: 0; padding: 20px; display: flex; justify-content: center; align-items: flex-start; }
        .container { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 20px; max-width: 600px; width: 100%; }
        h1, h2 { color: #5865F2; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .input-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; }
        input[type="text"], input[type="password"] { width: 95%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 16px; }
        button { background-color: #5865F2; color: #fff; border: none; padding: 12px 20px; border-radius: 4px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; width: 100%; margin-top: 10px; }
        button:hover { background-color: #4752C4; }
        button:disabled { background-color: #a0a0a0; cursor: not-allowed; }
        #status { margin-top: 20px; padding: 15px; background-color: #f0f2f5; border: 1px solid #ddd; border-radius: 4px; white-space: pre-wrap; word-wrap: break-word; font-family: 'Courier New', Courier, monospace; max-height: 200px; overflow-y: auto; }
        .hidden { display: none; }
        a { color: #5865F2; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ¤– Discord Bot Data Manager</h1>

    <div id="auth-section">
        <h2>1. ì¸ì¦ ì •ë³´ ì…ë ¥</h2>
        <div class="input-group">
            <label for="railway-token">Railway API Token</label>
            <input type="password" id="railway-token" placeholder="API í† í°ì„ ì…ë ¥í•˜ì„¸ìš”">
            <small>í† í°ì€ <a href="https://railway.app/account/tokens" target="_blank">ì—¬ê¸°</a>ì—ì„œ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>
        </div>
        <div class="input-group">
            <label for="project-id">Project ID</label>
            <input type="text" id="project-id" placeholder="í”„ë¡œì íŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
        </div>
        <div class="input-group">
            <label for="service-id">Service ID</label>
            <input type="text" id="service-id" placeholder="ì„œë¹„ìŠ¤ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”">
             <small>í”„ë¡œì íŠ¸/ì„œë¹„ìŠ¤ IDëŠ” Railway URLì—ì„œ ì°¾ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br> (.../project/<b>PROJECT_ID</b>/service/<b>SERVICE_ID</b>)</small>
        </div>
        <button id="save-auth">ì¸ì¦ ì •ë³´ ì €ì¥</button>
    </div>

    <div id="main-section" class="hidden">
        <h2>2. ë°ì´í„° ê´€ë¦¬</h2>
        <button id="backup-btn">ë°ì´í„° ë°±ì—… ì‹œì‘</button>
        
        <hr style="margin: 20px 0;">

        <h2>3. ë°ì´í„° ë³µì›</h2>
        <div class="input-group">
            <label for="backup-file">ë°±ì—… íŒŒì¼ ì„ íƒ (.tar.gz)</label>
            <input type="file" id="backup-file" accept=".tar.gz">
        </div>
        <button id="restore-btn" disabled>ë³µì› ì‹œì‘</button>
    </div>

    <div id="status">ìƒíƒœ ëŒ€ê¸° ì¤‘...</div>
</div>

<script>
    const railwayTokenInput = document.getElementById('railway-token');
    const projectIdInput = document.getElementById('project-id');
    const serviceIdInput = document.getElementById('service-id');
    const saveAuthBtn = document.getElementById('save-auth');
    const backupBtn = document.getElementById('backup-btn');
    const restoreBtn = document.getElementById('restore-btn');
    const backupFileInput = document.getElementById('backup-file');
    const statusDiv = document.getElementById('status');
    const authSection = document.getElementById('auth-section');
    const mainSection = document.getElementById('main-section');

    const RAILWAY_API_URL = 'https://backboard.railway.app/graphql/v2';
    // Netlify í”„ë¡ì‹œ ì£¼ì†ŒëŠ” ìƒëŒ€ ê²½ë¡œë¡œ ì§€ì •í•©ë‹ˆë‹¤.
    const OUR_PROXY_URL = '/.netlify/functions/proxy'; 

    // Railway API í˜¸ì¶œ í•¨ìˆ˜ (ìˆ˜ì •ë¨)
    async function callRailwayAPI(query, token) {
        try {
            const response = await fetch(OUR_PROXY_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    // í”„ë¡ì‹œ(proxy.js)ê°€ ì´í•´í•  ìˆ˜ ìˆëŠ” í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³´ëƒ…ë‹ˆë‹¤.
                    railway_url: RAILWAY_API_URL,
                    options: {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ query })
                    }
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ì˜¤ë¥˜! ìƒíƒœ: ${response.status}, ë‚´ìš©: ${errorText}`);
            }
            
            const result = await response.json();
            if (result.errors) { throw new Error(result.errors.map(e => e.message).join('\n')); }
            
            // ì˜¤ë¥˜ê°€ API ì‘ë‹µ ë‚´ë¶€ì— ìˆëŠ” ê²½ìš° ì²˜ë¦¬
            if (result.data && result.data.serviceInstanceExec && result.data.serviceInstanceExec.stderr) {
                throw new Error(result.data.serviceInstanceExec.stderr);
            }

            return result.data;
        } catch (error) {
            updateStatus(`API í˜¸ì¶œ ì‹¤íŒ¨: ${error.message}`);
            throw error; // ì˜¤ë¥˜ë¥¼ ìƒìœ„ë¡œ ì „íŒŒí•˜ì—¬ catch ë¸”ë¡ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡ í•¨
        }
    }

    // ì›ê²© ëª…ë ¹ì–´ ì‹¤í–‰ í•¨ìˆ˜
    async function executeCommand(command, token, serviceId) {
        // ë°±ìŠ¬ë˜ì‹œì™€ ë”°ì˜´í‘œë¥¼ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬í•˜ì—¬ JSON ë¬¸ìì—´ ë¬¸ì œë¥¼ ë°©ì§€í•©ë‹ˆë‹¤.
        const escapedCommand = command.replace(/\\/g, '\\\\').replace(/"/g, '\\"');
        const query = `
            mutation {
                serviceInstanceExec(serviceId: "${serviceId}", command: "${escapedCommand}") {
                    stdout
                    stderr
                }
            }`;
        const data = await callRailwayAPI(query, token);
        const result = data.serviceInstanceExec;
        // stdoutì´ ë¹„ì–´ìˆìœ¼ë©´ stderrì„ ë°˜í™˜í•  ìˆ˜ ìˆë„ë¡ ìˆ˜ì •
        if (result.stderr && !result.stdout) { throw new Error(result.stderr); }
        return result.stdout;
    }

    // ì„œë¹„ìŠ¤ ì¬ë°°í¬ í•¨ìˆ˜
    async function redeployService(token, serviceId) {
        const query = `
            mutation {
                serviceRedeploy(serviceId: "${serviceId}", input: {}) {
                    id
                }
            }`;
        return await callRailwayAPI(query, token);
    }
    
    function updateStatus(message) {
        console.log(message);
        statusDiv.textContent = message;
    }

    function loadAuthInfo() {
        const token = localStorage.getItem('railwayToken');
        const projectId = localStorage.getItem('railwayProjectId');
        const serviceId = localStorage.getItem('railwayServiceId');
        if (token && projectId && serviceId) {
            railwayTokenInput.value = token;
            projectIdInput.value = projectId;
            serviceIdInput.value = serviceId;
            authSection.classList.add('hidden');
            mainSection.classList.remove('hidden');
            updateStatus('ì¸ì¦ ì •ë³´ê°€ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë°±ì—… ë˜ëŠ” ë³µì›ì„ ì‹œì‘í•˜ì„¸ìš”.');
        }
    }

    saveAuthBtn.addEventListener('click', () => {
        const token = railwayTokenInput.value.trim();
        const projectId = projectIdInput.value.trim();
        const serviceId = serviceIdInput.value.trim();
        if (token && projectId && serviceId) {
            localStorage.setItem('railwayToken', token);
            localStorage.setItem('railwayProjectId', projectId);
            localStorage.setItem('railwayServiceId', serviceId);
            authSection.classList.add('hidden');
            mainSection.classList.remove('hidden');
            updateStatus('ì¸ì¦ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. ë°±ì—… ë˜ëŠ” ë³µì›ì„ ì‹œì‘í•˜ì„¸ìš”.');
        } else {
            alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        }
    });

    backupFileInput.addEventListener('change', () => {
        restoreBtn.disabled = !backupFileInput.files.length > 0;
    });

    backupBtn.addEventListener('click', async () => {
        if (!confirm('ë°ì´í„° ë°±ì—…ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
        backupBtn.disabled = true;
        restoreBtn.disabled = true;

        try {
            const token = localStorage.getItem('railwayToken');
            const serviceId = localStorage.getItem('railwayServiceId');
            
            updateStatus('1/3: ì„œë²„ì—ì„œ bot_data í´ë”ë¥¼ ì••ì¶• ì¤‘ì…ë‹ˆë‹¤...');
            await executeCommand('tar -czf backup.tar.gz bot_data', token, serviceId);
            
            updateStatus('2/3: ë‹¤ìš´ë¡œë“œ ë§í¬ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...');
            // transfer.shëŠ” ê°€ë” ë¶ˆì•ˆì •í•˜ë¯€ë¡œ ëŒ€ì²´ ì„œë¹„ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ stderrë¥¼ í™•ì¸í•˜ëŠ” ê²ƒì´ ì¢‹ìŒ
            const downloadUrl = await executeCommand('curl --upload-file ./backup.tar.gz https://transfer.sh/backup.tar.gz', token, serviceId);
            
            if (!downloadUrl || !downloadUrl.startsWith('http')) {
                throw new Error('ë‹¤ìš´ë¡œë“œ URL ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (transfer.sh ì„œë¹„ìŠ¤ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
            }

            updateStatus(`3/3: ë°±ì—… ì™„ë£Œ!\nì•„ë˜ ë§í¬ë¥¼ í´ë¦­í•˜ì—¬ íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”:\n\n${downloadUrl}`);
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.target = '_blank';
            link.textContent = downloadUrl;
            statusDiv.appendChild(document.createElement('br'));
            statusDiv.appendChild(link);

        } catch (error) {
            updateStatus(`ë°±ì—… ì‹¤íŒ¨: ${error.message}`);
        } finally {
            backupBtn.disabled = false;
        }
    });

    restoreBtn.addEventListener('click', async () => {
        if (!confirm('ë°ì´í„° ë³µì›ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì„œë²„ì˜ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.')) return;
        backupBtn.disabled = true;
        restoreBtn.disabled = true;
        
        try {
            const token = localStorage.getItem('railwayToken');
            const serviceId = localStorage.getItem('railwayServiceId');
            const file = backupFileInput.files[0];

            updateStatus('1/5: ë°±ì—… íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ ë§í¬ë¥¼ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...');
            
            const uploadResponse = await fetch('https://transfer.sh', {
                method: 'PUT',
                body: file,
                headers: { 'Content-Type': 'application/x-gzip' }
            });
            const uploadUrl = await uploadResponse.text();
            
            if (!uploadUrl.startsWith('http')) {
                throw new Error('ë°±ì—… íŒŒì¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (transfer.sh ì„œë¹„ìŠ¤ ë¬¸ì œì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
            }
            updateStatus(`2/5: ì—…ë¡œë“œ ì™„ë£Œ. URL: ${uploadUrl}`);

            updateStatus('3/5: ì„œë²„ì—ì„œ ë°±ì—… íŒŒì¼ì„ ë‹¤ìš´ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...');
            await executeCommand(`curl -o backup.tar.gz ${uploadUrl}`, token, serviceId);

            updateStatus('4/5: ì„œë²„ì—ì„œ ë°ì´í„° ì••ì¶•ì„ í‘¸ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
            try {
                await executeCommand('tar -xzf backup.tar.gz -C /data/', token, serviceId);
                updateStatus('ë³¼ë¥¨ì— ë°ì´í„°ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤.');
            } catch (e) {
                await executeCommand('tar -xzf backup.tar.gz', token, serviceId);
                updateStatus('ê¸°ë³¸ ìœ„ì¹˜ì— ë°ì´í„°ë¥¼ ë³µì›í–ˆìŠµë‹ˆë‹¤. (ë³¼ë¥¨ ë¯¸ì‚¬ìš©)');
            }

            updateStatus('5/5: ë´‡ ì„œë¹„ìŠ¤ë¥¼ ì¬ì‹œì‘í•˜ì—¬ ë³€ê²½ì‚¬í•­ì„ ì ìš©í•©ë‹ˆë‹¤...');
            await redeployService(token, serviceId);

            updateStatus('ë³µì› ì™„ë£Œ! ì„œë¹„ìŠ¤ê°€ ì¬ì‹œì‘ë  ë•Œê¹Œì§€ ëª‡ ë¶„ ì •ë„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.');
            
        } catch (error) {
            updateStatus(`ë³µì› ì‹¤íŒ¨: ${error.message}`);
        } finally {
            backupBtn.disabled = false;
            restoreBtn.disabled = false;
        }
    });
    
    loadAuthInfo();
</script>

</body>
</html>